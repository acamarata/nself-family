name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v0.9)'
        required: true
        type: string
      confirm:
        description: 'Type DEPLOY to confirm production deployment'
        required: true
        type: string

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Confirm deployment intent
        run: |
          if [ "${{ inputs.confirm }}" != "DEPLOY" ]; then
            echo "Deployment not confirmed. Type DEPLOY to proceed."
            exit 1
          fi
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      - name: Verify tag exists
        run: git describe --exact-match --tags HEAD

  deploy-frontend:
    name: Deploy Frontend to Production
    needs: [validate]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml
      - name: Install dependencies
        run: cd frontend && pnpm install --frozen-lockfile
      - name: Build
        run: cd frontend && pnpm build
        env:
          NEXT_PUBLIC_API_URL: https://family.nself.org/api
          NEXT_PUBLIC_AUTH_URL: https://family.nself.org/auth
          NEXT_PUBLIC_WS_URL: wss://family.nself.org/ws
          NEXT_PUBLIC_DEMO_MODE: "true"
          NEXT_TELEMETRY_DISABLED: 1
      - name: Deploy to Vercel (Production)
        run: |
          npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ vars.VERCEL_TEAM_ID }}
        working-directory: frontend

  deploy-backend:
    name: Deploy Backend to Production
    needs: [validate]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_SSH_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/nself-family
            git fetch --tags
            git checkout ${{ inputs.version }}
            cd backend
            nself build
            nself restart
            nself health

  verify:
    name: Post-deploy Verification
    needs: [deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Health check backend
        run: |
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://family.nself.org/api/health || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "Backend healthy"
              exit 0
            fi
            echo "Attempt $i: status $STATUS, retrying in 10s..."
            sleep 10
          done
          echo "Backend health check failed"
          exit 1
      - name: Health check frontend
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://family.nself.org || echo "000")
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
            echo "Frontend healthy"
          else
            echo "Frontend health check failed with status $STATUS"
            exit 1
          fi

  rollback:
    name: Rollback on Failure
    needs: [verify]
    if: failure()
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Rollback backend
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ vars.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_SSH_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/nself-family
            # Get the previous tag
            PREV_TAG=$(git tag --sort=-creatordate | head -2 | tail -1)
            echo "Rolling back to $PREV_TAG"
            git checkout "$PREV_TAG"
            cd backend
            nself build
            nself restart
            nself health
      - name: Notify rollback
        run: echo "Production deployment failed - rolled back to previous version"
