# Tracked tables with RBAC permissions
# Roles: OWNER, ADMIN, ADULT_MEMBER, YOUTH_MEMBER, CHILD_MEMBER, DEVICE, anonymous

# ============================================================================
# Users (global)
# ============================================================================
- table:
    schema: public
    name: users
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - email
          - display_name
          - avatar_url
          - profile
          - email_verified
          - created_at
        filter:
          id:
            _eq: X-Hasura-User-Id
    - role: admin
      permission:
        columns:
          - id
          - email
          - display_name
          - avatar_url
          - profile
          - email_verified
          - is_active
          - created_at
          - updated_at
        filter: {}
  update_permissions:
    - role: user
      permission:
        columns:
          - display_name
          - avatar_url
          - profile
        filter:
          id:
            _eq: X-Hasura-User-Id
    - role: admin
      permission:
        columns:
          - display_name
          - avatar_url
          - profile
          - is_active
        filter: {}

# ============================================================================
# Families
# ============================================================================
- table:
    schema: public
    name: families
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - name
          - description
          - settings
          - created_at
        filter:
          family_members:
            user_id:
              _eq: X-Hasura-User-Id
    - role: admin
      permission:
        columns: "*"
        filter: {}
  insert_permissions:
    - role: admin
      permission:
        columns:
          - name
          - description
          - settings
        check: {}
  update_permissions:
    - role: admin
      permission:
        columns:
          - name
          - description
          - settings
        filter: {}

# ============================================================================
# Family members (family-scoped)
# ============================================================================
- table:
    schema: public
    name: family_members
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - user_id
          - role
          - lifecycle_state
          - display_name
          - joined_at
        filter:
          family_id:
            _in: X-Hasura-Family-Ids
    - role: admin
      permission:
        columns: "*"
        filter: {}
  insert_permissions:
    - role: admin
      permission:
        columns:
          - family_id
          - user_id
          - role
          - display_name
        check:
          family_id:
            _in: X-Hasura-Family-Ids
  update_permissions:
    - role: admin
      permission:
        columns:
          - role
          - lifecycle_state
          - display_name
        filter:
          family_id:
            _in: X-Hasura-Family-Ids

# ============================================================================
# Relationships (family-scoped)
# ============================================================================
- table:
    schema: public
    name: relationships
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - user_a_id
          - user_b_id
          - relation_type
          - is_mahram
          - metadata
        filter:
          family_id:
            _in: X-Hasura-Family-Ids
    - role: admin
      permission:
        columns: "*"
        filter: {}

# ============================================================================
# Apps (global, read-only for users)
# ============================================================================
- table:
    schema: public
    name: apps
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - app_key
          - name
          - description
        filter:
          is_active:
            _eq: true
    - role: admin
      permission:
        columns: "*"
        filter: {}
    - role: anonymous
      permission:
        columns:
          - app_key
          - name
          - description
        filter:
          is_active:
            _eq: true

# ============================================================================
# User app roles (per-app RBAC)
# ============================================================================
- table:
    schema: public
    name: user_app_roles
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - user_id
          - app_id
          - role
          - permissions
        filter:
          user_id:
            _eq: X-Hasura-User-Id
    - role: admin
      permission:
        columns: "*"
        filter: {}
  insert_permissions:
    - role: admin
      permission:
        columns:
          - user_id
          - app_id
          - role
          - permissions
        check: {}
  update_permissions:
    - role: admin
      permission:
        columns:
          - role
          - permissions
        filter: {}

# ============================================================================
# Posts (family-scoped)
# ============================================================================
- table:
    schema: public
    name: posts
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - author_id
          - post_type
          - title
          - body
          - visibility
          - metadata
          - is_pinned
          - created_at
          - updated_at
        filter:
          _and:
            - family_id:
                _in: X-Hasura-Family-Ids
            - is_deleted:
                _eq: false
    - role: admin
      permission:
        columns: "*"
        filter:
          family_id:
            _in: X-Hasura-Family-Ids
  insert_permissions:
    - role: user
      permission:
        columns:
          - family_id
          - post_type
          - title
          - body
          - visibility
          - metadata
        check:
          family_id:
            _in: X-Hasura-Family-Ids
        set:
          author_id: X-Hasura-User-Id
  update_permissions:
    - role: user
      permission:
        columns:
          - title
          - body
          - visibility
          - metadata
          - is_pinned
        filter:
          _and:
            - family_id:
                _in: X-Hasura-Family-Ids
            - author_id:
                _eq: X-Hasura-User-Id

# ============================================================================
# Media items (family-scoped)
# ============================================================================
- table:
    schema: public
    name: media_items
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - uploaded_by
          - file_name
          - mime_type
          - file_size
          - storage_path
          - width
          - height
          - duration_ms
          - processing_status
          - created_at
        filter:
          _and:
            - family_id:
                _in: X-Hasura-Family-Ids
            - is_deleted:
                _eq: false
    - role: admin
      permission:
        columns: "*"
        filter:
          family_id:
            _in: X-Hasura-Family-Ids

# ============================================================================
# Media variants
# ============================================================================
- table:
    schema: public
    name: media_variants
  select_permissions:
    - role: user
      permission:
        columns: "*"
        filter:
          media_item:
            family_id:
              _in: X-Hasura-Family-Ids
    - role: admin
      permission:
        columns: "*"
        filter: {}

# ============================================================================
# Post assets
# ============================================================================
- table:
    schema: public
    name: post_assets
  select_permissions:
    - role: user
      permission:
        columns: "*"
        filter:
          post:
            family_id:
              _in: X-Hasura-Family-Ids
    - role: admin
      permission:
        columns: "*"
        filter: {}

# ============================================================================
# Live events (family-scoped)
# ============================================================================
- table:
    schema: public
    name: live_events
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - created_by
          - title
          - description
          - event_type
          - starts_at
          - ends_at
          - location
          - visibility
          - is_recurring
          - is_cancelled
          - created_at
        filter:
          _and:
            - family_id:
                _in: X-Hasura-Family-Ids
            - is_cancelled:
                _eq: false
    - role: admin
      permission:
        columns: "*"
        filter:
          family_id:
            _in: X-Hasura-Family-Ids
  insert_permissions:
    - role: user
      permission:
        columns:
          - family_id
          - title
          - description
          - event_type
          - starts_at
          - ends_at
          - location
          - location_geo
          - visibility
          - is_recurring
          - recurrence_rule
        check:
          family_id:
            _in: X-Hasura-Family-Ids
        set:
          created_by: X-Hasura-User-Id

# ============================================================================
# Audit events (read-only for admins)
# ============================================================================
- table:
    schema: public
    name: audit_events
  select_permissions:
    - role: admin
      permission:
        columns: "*"
        filter:
          family_id:
            _in: X-Hasura-Family-Ids

# ============================================================================
# Device registrations (family-scoped)
# ============================================================================
- table:
    schema: public
    name: device_registrations
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - device_name
          - device_type
          - platform
          - is_active
          - last_seen_at
        filter:
          family_id:
            _in: X-Hasura-Family-Ids
    - role: admin
      permission:
        columns: "*"
        filter:
          family_id:
            _in: X-Hasura-Family-Ids

# ============================================================================
# Inheritance scenarios (family-scoped)
# ============================================================================
- table:
    schema: public
    name: inheritance_scenarios
  select_permissions:
    - role: user
      permission:
        columns:
          - id
          - family_id
          - title
          - description
          - is_active
          - version
          - created_at
        filter:
          _and:
            - family_id:
                _in: X-Hasura-Family-Ids
            - user_id:
                _eq: X-Hasura-User-Id
    - role: admin
      permission:
        columns: "*"
        filter:
          family_id:
            _in: X-Hasura-Family-Ids
